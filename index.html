<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Futuro Financeiro e Previdenciário (V10.7)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .card { box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); border-radius: 1.5rem; }
        .input-text { border-color: #d1d5db; padding: 0.75rem; transition: border-color 0.2s; }
        .input-text:focus { border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }
        .chart-container { 
            position: relative; 
            width: 100%; 
            min-height: 300px;
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 1rem;
            margin-top: 1.5rem;
        }
        /* Estilo para a tabela CNIS estendida */
        #cnis_salary_table_container {
            max-height: 400px; /* Limita a altura */
            overflow-y: auto; /* Adiciona scroll vertical */
            padding-right: 1rem;
        }
        .text-error { color: #dc2626; font-weight: 600; }
        /* Estilo para a remoção dinâmica de investimento */
        .investment-item {
            position: relative;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            background-color: #f9fafb;
        }
        .remove-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            line-height: 1;
            cursor: pointer;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-6xl mx-auto bg-white p-6 sm:p-10 rounded-3xl card">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">
                Simulador Financeiro e Previdenciário (V10.7)
            </h1>
            <p class="text-lg text-gray-500 mt-2">
                Simulação Previdenciária e Projeção de Múltiplos Investimentos.
            </p>
        </header>

        <section id="input_form" class="space-y-8">
            
            <div class="p-6 bg-indigo-50 rounded-2xl border border-indigo-200">
                <h2 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">Dados Pessoais e Previdenciários</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="birth_date" class="block text-sm font-medium text-gray-700">Data de Nascimento</label>
                        <input type="date" id="birth_date" value="1990-01-01" class="mt-1 block w-full input-text rounded-lg">
                        <p id="current_age_display" class="mt-2 text-sm font-semibold text-indigo-600"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Gênero</label>
                        <div class="mt-2 flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="gender" value="M" checked class="form-radio text-indigo-600 h-4 w-4">
                                <span class="ml-2 text-gray-700">Homem</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="gender" value="F" class="form-radio text-indigo-600 h-4 w-4">
                                <span class="ml-2 text-gray-700">Mulher</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label for="current_salary" class="block text-sm font-medium text-gray-700">Salário Atual (R$)</label>
                        <input type="number" id="current_salary" value="3000" min="0" step="100" class="mt-1 block w-full input-text rounded-lg">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label for="cnis_start_year" class="block text-sm font-medium text-gray-700">Histórico Salarial CNIS a Partir de (Ano)</label>
                        <input type="number" id="cnis_start_year" value="2010" min="1994" max="2025" class="mt-1 block w-full input-text rounded-lg" onchange="generateSalaryTable(); calculateAndDisplayProjections()">
                    </div>
                    
                    <div class="flex items-start flex-col">
                        <label for="simulate_disability" class="inline-flex items-center p-3 bg-white rounded-lg border w-full h-fit mb-2 cursor-pointer">
                            <input type="checkbox" id="simulate_disability" class="form-checkbox text-red-600 h-5 w-5 rounded" onchange="toggleDisabilityOptions(); calculateAndDisplayProjections()">
                            <span class="ml-2 text-sm font-medium text-gray-700">Simular Aposentadoria por Invalidez</span>
                        </label>

                        <div id="disability_options" class="flex flex-col space-y-1 p-2 bg-white rounded-lg border w-full hidden">
                            <label class="text-sm font-semibold text-gray-700">Tipo de Invalidez:</label>
                            <label class="inline-flex items-center text-sm">
                                <input type="radio" name="disability_type" value="common" checked class="form-radio text-red-600 h-4 w-4" onchange="calculateAndDisplayProjections()">
                                <span class="ml-2 text-gray-700">Comum (Regra 60% + 2%)</span>
                            </label>
                            <label class="inline-flex items-center text-sm">
                                <input type="radio" name="disability_type" value="work_related" class="form-radio text-red-600 h-4 w-4" onchange="calculateAndDisplayProjections()">
                                <span class="ml-2 text-gray-700">Acidentária (Regra 100%)</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 bg-yellow-50 rounded-2xl border border-yellow-200">
                <h2 class="text-xl font-bold text-yellow-700 mb-4 border-b pb-2">Histórico Salarial (CNIS)</h2>
                <p class="text-sm text-gray-600 mb-4 font-bold">⚠️ Insira o TOTAL ANUAL de salário de contribuição (R$) para o cálculo da Média Salarial. Anos com valor R$ 0,00 ou em branco são ignorados e não contam tempo de contribuição.</p>
                <div id="cnis_salary_table_container">
                    <div id="cnis_salary_table" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"> 
                        </div>
                </div>
                
                <p id="total_contributed_time_display" class="mt-4 text-md font-bold text-yellow-800">Tempo de Contribuição Total Válido: <span class="text-error">0 anos e 0 meses</span></p>
                <p id="average_salary_display" class="mt-2 text-md font-bold text-yellow-700">Média Salarial de Contribuição (Mensal Base): <span class="text-error">R$ 0,00</span></p>
            </div>

            <div class="p-6 bg-green-50 rounded-2xl border border-green-200">
                <h2 class="text-xl font-bold text-green-700 mb-4 border-b pb-2">Dados de Investimento e Projeção</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label for="investment_years_target" class="block text-sm font-medium text-gray-700">Tempo de Investimento (Anos)</label>
                        <input type="number" id="investment_years_target" value="20" min="1" max="60" class="mt-1 block w-full input-text rounded-lg" oninput="calculateAndDisplayProjections()">
                    </div>
                    <div>
                        <label for="inflation_rate" class="block text-sm font-medium text-gray-700">Taxa de Inflação Anual (%)</label>
                        <input type="number" id="inflation_rate" value="4" min="0" max="10" step="0.1" class="mt-1 block w-full input-text rounded-lg" oninput="calculateAndDisplayProjections()">
                    </div>
                    <div>
                        <label for="placeholder_income" class="block text-sm font-medium text-gray-700 opacity-0">Placeholder</label>
                        <input type="hidden" id="placeholder_income" class="mt-1 block w-full input-text rounded-lg">
                    </div>
                </div>

                <div id="investments_container" class="space-y-4">
                    </div>
                
                <button type="button" onclick="addInvestmentField()" class="mt-4 px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-300">
                    + Adicionar Outro Investimento
                </button>
            </div>

            <div class="text-center pt-4 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button onclick="calculateAndDisplayProjections()" class="px-8 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105">
                    Calcular Projeções
                </button>
                
                <button onclick="saveDataToJson()" class="px-6 py-3 bg-gray-600 text-white font-semibold rounded-xl shadow-lg hover:bg-gray-700 transition duration-300">
                    Salvar Dados (JSON)
                </button>
                <input type="file" id="json_upload" accept=".json" class="hidden" onchange="handleJsonUpload(event)">
                <button onclick="document.getElementById('json_upload').click()" class="px-6 py-3 bg-gray-200 text-gray-800 font-semibold rounded-xl shadow-lg hover:bg-gray-300 transition duration-300">
                    Carregar Dados (JSON)
                </button>
            </div>
        </section>

        <section id="results_section" class="hidden mt-12 pt-8 border-t-2 border-indigo-100">
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 text-center mb-8">Resultados da Simulação</h2>
            
            <div class="p-6 bg-blue-100 rounded-xl mb-8 border-blue-300 border-l-4">
                <h3 class="text-xl font-bold text-blue-800 mb-3">Resumo Previdenciário (INSS Simplificado)</h3>
                <div id="inss_results" class="space-y-2 text-gray-700">
                    <p class="font-bold text-blue-800">Tempo de Contribuição Total Válido: <span id="total_time_summary" class="text-indigo-600"></span></p>
                    <hr class="border-blue-200 my-2">
                    <p><span class="font-semibold text-green-700">Tempo Contribuído no Teto (Período CNIS):</span> <span id="teto_contributed_time" class="text-green-600 font-bold"></span></p>
                    <p><span class="font-semibold text-red-700">Tempo Contribuído Abaixo do Teto (Período CNIS):</span> <span id="below_teto_contributed_time" class="text-red-600 font-bold"></span></p>
                    <hr class="border-blue-200 my-2">
                    <p><span class="font-semibold">Média Salarial de Contribuição (SB - Base do Benefício):</span> <span id="inss_average_salary_base" class="text-blue-600 font-bold"></span></p>
                    <p><span class="font-semibold">Idade Mínima para Aposentadoria:</span> <span id="inss_min_age" class="text-blue-600 font-bold"></span></p>
                    <p><span class="font-semibold">Tempo de Contribuição Necessário:</span> <span id="inss_min_time" class="text-blue-600 font-bold"></span></p>
                    <p><span class="font-semibold">Faltam Anos de Contribuição:</span> <span id="inss_remaining_time" class="text-red-600 font-bold"></span></p>
                    <p class="font-bold"><span class="text-lg">Projeção de Renda INSS Estimada (RMI):</span> <span id="inss_projected_income" class="text-indigo-700 font-extrabold text-lg"></span> <span class="text-red-700 text-sm italic">(Limitado ao Teto INSS Atual (2025): R$ 8.157,41)</span></p>
                    <p id="inss_coefficient_note" class="text-sm font-medium text-gray-600"></p>
                </div>
            </div>

            <div class="p-6 bg-indigo-100 rounded-xl mb-8 border-indigo-300 border-l-4">
                <h3 class="text-xl font-bold text-indigo-800 mb-3">Resumo da Projeção Financeira (Apenas Investimentos)</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-700">
                    <p><span class="font-semibold">Período de Investimento:</span> <span id="years_to_retirement" class="text-indigo-600 font-bold"></span></p>
                    <p><span class="font-semibold">Capital Acumulado Total (Nominal):</span> <span id="total_nominal_capital" class="text-indigo-600 font-bold"></span></p>
                    <p><span class="font-semibold">Capital Acumulado Total (Real - ajustado pela inflação):</span> <span id="total_real_capital" class="text-indigo-600 font-bold"></span></p>
                    <p><span class="font-semibold">Renda Mensal Gerada por Investimentos (Renda Passiva Real):</span> <span id="passive_income" class="text-green-600 font-bold"></span></p>
                </div>
                
                <div id="detailed_investment_summary" class="mt-4 pt-4 border-t border-indigo-200 space-y-2">
                    </div>
            </div>

            <div class="grid grid-cols-1 gap-8 mt-8">
                <h3 class="text-2xl font-semibold text-gray-700 text-center">Gráfico de Crescimento do Capital</h3>
                <div id="investment_chart" class="chart-container"></div>
            </div>
        </section>
        
        <footer class="mt-12 pt-6 border-t border-gray-200 text-center text-sm text-gray-500 space-y-2">
            <p>© 2025 Alex Silva.</p>
            <p class="italic text-xs text-red-500">
                ⚠️ Este é apenas um simulador sujeito a falhas. Os cálculos são ESTIMADOS e não substituem uma consulta com um profissional qualificado em planejamento previdenciário e financeiro.
            </p>
            <p class="mt-2">
                <a href="#" onclick="showPrivacyModal(event)" class="text-indigo-600 hover:text-indigo-800 font-semibold underline text-xs">
                    Política de Privacidade e LGPD
                </a>
            </p>
        </footer>

        <div id="message_modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                <p id="modal_message" class="text-gray-800 font-medium"></p>
                <button onclick="document.getElementById('message_modal').classList.add('hidden'); document.getElementById('message_modal').classList.remove('flex');" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                    Entendi
                </button>
            </div>
        </div>

        <div id="privacy_modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
            <div class="bg-white p-8 rounded-lg shadow-xl max-w-lg w-full">
                <h3 class="text-xl font-bold text-indigo-700 mb-4">🔒 Política de Privacidade (LGPD)</h3>
                <p class="text-gray-700 mb-4">
                    Este simulador funciona integralmente no seu navegador (processamento **Client-Side**).
                </p>
                <ul class="list-disc ml-5 space-y-2 text-gray-600 text-sm">
                    <li>Seus dados pessoais (data de nascimento, salários, etc.) são usados **apenas para fins de cálculo e simulação** e não são necessários para o funcionamento.</li>
                    <li>**Nenhum dado é enviado, armazenado ou acessado** por servidores externos ou pelo desenvolvedor.</li>
                    <li>O único armazenamento ocorre localmente no seu dispositivo (se você usar a função 'Salvar Dados JSON').</li>
                    <li>Você mantém total controle e propriedade de todos os dados inseridos.</li>
                </ul>
                <button onclick="document.getElementById('privacy_modal').classList.add('hidden'); document.getElementById('privacy_modal').classList.remove('flex');" class="mt-6 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                    Compreendi
                </button>
            </div>
        </div>

    </div>

    <script type="text/javascript">
        // Carrega o Google Charts
        google.charts.load('current', {'packages':['corechart']});

        // --- Variáveis Globais e Constantes ---
        const CURRENT_VERSION = "V10.7";
        const MIN_AGE_M = 65; 
        const MIN_CONTRIBUTION_M = 35; 
        const MIN_AGE_F = 62; 
        const MIN_CONTRIBUTION_F = 30; 
        
        const INSS_TETO_HISTORICO = {
            1994: 582.86, 1995: 832.66, 1996: 957.56, 1997: 1031.87, 1998: 1200.00, 
            1999: 1255.32, 2000: 1328.25, 2001: 1430.00, 2002: 1561.56, 2003: 1869.34,
            2004: 2508.72, 2005: 2668.15, 2006: 2801.56, 2007: 2894.28, 2008: 3038.99,
            2009: 3218.90, 2010: 3467.40, 2011: 3691.74, 2012: 3916.20, 2013: 4159.00,
            2014: 4390.24, 2015: 4663.75, 2016: 5189.82, 2017: 5531.31, 2018: 5645.80,
            2019: 5839.45, 2020: 6101.06, 2021: 6433.57, 2022: 7087.22, 2023: 7507.49,
            2024: 7786.02, 
            2025: 8157.41 
        };
        const CURRENT_INSS_TETO = INSS_TETO_HISTORICO[2025]; 
        
        let investmentCounter = 0; 

        // --- FUNÇÕES DE UTILIDADE ---

        function showMessage(message) {
            document.getElementById('modal_message').innerText = message;
            document.getElementById('message_modal').classList.remove('hidden');
            document.getElementById('message_modal').classList.add('flex');
        }

        function showPrivacyModal(event) {
            event.preventDefault(); // Impede o link de navegar
            document.getElementById('privacy_modal').classList.remove('hidden');
            document.getElementById('privacy_modal').classList.add('flex');
        }

        function formatCurrency(value) {
            if (isNaN(value) || value === null) return 'R$ 0,00';
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        
        function calculateAge(birthDateString) {
            const birthDate = new Date(birthDateString);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function toggleDisabilityOptions() {
            const checkbox = document.getElementById('simulate_disability');
            const optionsDiv = document.getElementById('disability_options');
            if (checkbox.checked) {
                optionsDiv.classList.remove('hidden');
            } else {
                optionsDiv.classList.add('hidden');
            }
        }

        // --- GESTÃO DE INVESTIMENTOS DINÂMICOS ---

        function addInvestmentField(data = {}) {
            investmentCounter++;
            const container = document.getElementById('investments_container');
            const newDiv = document.createElement('div');
            newDiv.className = 'investment-item';
            
            const id = data.id || investmentCounter;
            newDiv.id = `inv_${id}`;

            const initialValue = data.initial !== undefined ? data.initial : 10000;
            const monthlyValue = data.monthly !== undefined ? data.monthly : 500;
            const interestValue = data.interest !== undefined ? (data.interest * 100).toFixed(1) : 8.0; 

            newDiv.innerHTML = `
                <button type="button" class="remove-btn" onclick="removeInvestmentField('inv_${id}')">×</button>
                <h4 class="text-md font-semibold text-gray-700 mb-3">Investimento #${id}</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="initial_investment_${id}" class="block text-sm font-medium text-gray-700">Valor Inicial (R$)</label>
                        <input type="number" id="initial_investment_${id}" value="${initialValue}" min="0" class="mt-1 block w-full input-text rounded-lg" oninput="calculateAndDisplayProjections()">
                    </div>
                    <div>
                        <label for="monthly_contribution_${id}" class="block text-sm font-medium text-gray-700">Aporte Mensal (R$)</label>
                        <input type="number" id="monthly_contribution_${id}" value="${monthlyValue}" min="0" class="mt-1 block w-full input-text rounded-lg" oninput="calculateAndDisplayProjections()">
                    </div>
                    <div>
                        <label for="annual_interest_${id}" class="block text-sm font-medium text-gray-700">Rentabilidade Anual (%)</label>
                        <input type="number" id="annual_interest_${id}" value="${interestValue}" min="0" max="30" step="0.1" class="mt-1 block w-full input-text rounded-lg" oninput="calculateAndDisplayProjections()">
                    </div>
                </div>
            `;
            container.appendChild(newDiv);
            return id;
        }

        function removeInvestmentField(id) {
            const element = document.getElementById(id);
            if (element) {
                element.remove();
                calculateAndDisplayProjections(); 
            }
        }
        
        function getInvestmentData() {
            const investments = [];
            const container = document.getElementById('investments_container');
            const items = container.querySelectorAll('.investment-item');
            
            items.forEach(item => {
                const id = item.id.split('_')[1];
                investments.push({
                    initial: parseFloat(document.getElementById(`initial_investment_${id}`).value) || 0,
                    monthly: parseFloat(document.getElementById(`monthly_contribution_${id}`).value) || 0,
                    interest: parseFloat(document.getElementById(`annual_interest_${id}`).value) / 100,
                    id: parseInt(id), 
                    name: `Investimento #${id}` 
                });
            });

            return investments;
        }


        // --- FUNÇÕES DE CÁLCULO PREVIDENCIÁRIO (INSS) ---

        function generateSalaryTable(loadedSalaries = {}) {
            const tableDiv = document.getElementById('cnis_salary_table');
            tableDiv.innerHTML = '';
            const currentYear = new Date().getFullYear();
            
            const startYearInput = document.getElementById('cnis_start_year');
            let startYear = parseInt(startYearInput.value) || 1994;

            if (startYear < 1994 || startYear > currentYear) {
                startYear = 1994;
                startYearInput.value = 1994;
            }

            const endYear = Math.max(currentYear, 2025); 
            
            for (let year = startYear; year <= endYear; year++) {
                const inputContainer = document.createElement('div');
                inputContainer.className = 'w-full';
                
                let valueToUse = loadedSalaries[year] !== undefined ? loadedSalaries[year] : 0;
                
                if (loadedSalaries[year] === undefined) {
                    const existingInput = document.getElementById(`salary_${year}`);
                    valueToUse = existingInput ? existingInput.value : 0;
                }
                
                inputContainer.innerHTML = `
                    <label for="salary_${year}" class="block text-xs font-medium text-gray-500">${year} (R$)</label>
                    <input type="number" id="salary_${year}" value="${valueToUse}" min="0" step="100" 
                           class="mt-1 block w-full input-text rounded-lg p-2 text-sm" oninput="calculateAndDisplayProjections()">
                `;
                tableDiv.appendChild(inputContainer);
            }
        }
        
        function analyzeContributionHistory() {
            const startYear = parseInt(document.getElementById('cnis_start_year').value) || 1994;
            const currentYear = new Date().getFullYear();
            const endYear = Math.max(currentYear, 2025); 
            
            let totalAnnualSalary = 0; 
            let tetoMonths = 0;
            let belowTetoMonths = 0;
            let cnisCalculatedMonths = 0; 

            const cnisSalaries = {}; 

            for (let year = startYear; year <= endYear; year++) {
                const input = document.getElementById(`salary_${year}`);
                const annualContribution = parseFloat(input?.value) || 0; 
                
                cnisSalaries[year] = annualContribution; 

                const tetoMensal = INSS_TETO_HISTORICO[year] || 0;

                const monthsContributed = annualContribution > 0 ? 12 : 0; 
                
                if (monthsContributed > 0) {
                    totalAnnualSalary += annualContribution; 
                    cnisCalculatedMonths += monthsContributed; 
                    
                    if (tetoMensal > 0) {
                        let tetoAnual = tetoMensal * 12;
                        
                        if (year === 1994 && startYear <= 1994) {
                            tetoAnual = tetoMensal * 6; 
                        }

                        if (annualContribution >= tetoAnual * 0.95) { 
                            tetoMonths += monthsContributed;
                        } else {
                            belowTetoMonths += monthsContributed;
                        }
                    } else {
                        belowTetoMonths += monthsContributed;
                    }
                }
            }
            
            const totalContributedYearsInt = Math.floor(cnisCalculatedMonths / 12);
            const totalContributedMonthsInt = cnisCalculatedMonths % 12;

            return {
                totalAnnualSalary,
                cnisCalculatedMonths,
                totalContributedYears: totalContributedYearsInt + (totalContributedMonthsInt/12),
                totalContributedYearsInt: totalContributedYearsInt,
                totalContributedMonthsInt: totalContributedMonthsInt,
                tetoMonths,
                belowTetoMonths,
                tetoYears: Math.floor(tetoMonths / 12),
                tetoRemainingMonths: tetoMonths % 12,
                belowTetoYears: Math.floor(belowTetoMonths / 12),
                belowTetoRemainingMonths: belowTetoMonths % 12,
                cnisSalaries 
            };
        }
        
        function calculateAverageSalary(history) {
            const totalSalary = history.totalAnnualSalary;
            const totalMonthsContributed = history.cnisCalculatedMonths;

            const averageMonthlySalary = totalMonthsContributed > 0 ? totalSalary / totalMonthsContributed : 0;

            document.getElementById('average_salary_display').innerHTML = 
                `Média Salarial de Contribuição (Mensal Base): <span class="text-green-700">${formatCurrency(averageMonthlySalary)}</span>`;
            
            return averageMonthlySalary; 
        }


        function calculateINSSProjection(currentAge, gender, history, averageMonthlySalary) {
            const isDisability = document.getElementById('simulate_disability').checked;
            const disabilityType = isDisability ? document.querySelector('input[name="disability_type"]:checked').value : 'none';
            
            const totalContributedYears = history.totalContributedYears;
            const totalContributedYearsInt = history.totalContributedYearsInt;
            const totalContributedMonthsInt = history.totalContributedMonthsInt; // BUG FIX APLICADO AQUI (V10.7)

            document.getElementById('total_contributed_time_display').innerHTML = 
                `Tempo de Contribuição Total Válido: <span class="text-indigo-600 font-bold">${totalContributedYearsInt} anos e ${totalContributedMonthsInt} meses</span>`;
            
            document.getElementById('total_time_summary').innerText = 
                `${totalContributedYearsInt} anos e ${totalContributedMonthsInt} meses`;

            document.getElementById('teto_contributed_time').innerText = 
                `${history.tetoYears} anos e ${history.tetoRemainingMonths} meses`;
            document.getElementById('below_teto_contributed_time').innerText = 
                `${history.belowTetoYears} anos e ${history.belowTetoRemainingMonths} meses`;


            const isMale = gender === 'M';
            const minAge = isMale ? MIN_AGE_M : MIN_AGE_F;
            const minContributionYears = isMale ? MIN_CONTRIBUTION_M : MIN_CONTRIBUTION_F;
            
            const yearsToContribute = Math.max(0, minContributionYears - totalContributedYears);
            const ageNeededByTime = currentAge + yearsToContribute;
            
            const retirementAge = Math.max(minAge, ageNeededByTime);
            
            let percentage = 0; 
            let projectedIncome = 0;
            let noteText = '';

            const baseYears = isMale ? 20 : 15;
            const excessYears = Math.max(0, totalContributedYears - baseYears);
            
            if (isDisability) {
                if (disabilityType === 'work_related') {
                    percentage = 1.0;
                    noteText = `Cálculo de Invalidez Acidentária: Coeficiente de ${Math.round(percentage * 100)}% aplicado sobre o Salário de Benefício.`;
                } else {
                    percentage = Math.min(1, 0.6 + (excessYears * 0.02)); 
                    noteText = `Cálculo de Invalidez Comum: Coeficiente de ${Math.round(percentage * 100)}% (60% + ${Math.round(excessYears * 2)}%) aplicado sobre o Salário de Benefício.`;
                }

            } else {
                percentage = Math.min(1, 0.6 + (excessYears * 0.02)); 
                noteText = `Cálculo de Aposentadoria Programada: Coeficiente de ${Math.round(percentage * 100)}% (60% + ${Math.round(excessYears * 2)}%) aplicado sobre o Salário de Benefício.`;
            }
            
            projectedIncome = averageMonthlySalary * percentage;

            projectedIncome = Math.min(projectedIncome, CURRENT_INSS_TETO);

            document.getElementById('inss_coefficient_note').innerText = noteText;
            
            return {
                totalContributedYears,
                minAge: minAge, 
                minContributionTime: minContributionYears, 
                remainingTime: yearsToContribute,
                projectedIncome: projectedIncome,
                isDisability: isDisability
            };
        }
        
        // --- FUNÇÕES DE SALVAR/CARREGAR JSON ---

        function saveDataToJson() {
            const history = analyzeContributionHistory(); 
            const investmentList = getInvestmentData(); 

            const data = {
                version: CURRENT_VERSION,
                date_saved: new Date().toISOString(),
                
                personal: {
                    birth_date: document.getElementById('birth_date').value,
                    gender: document.querySelector('input[name="gender"]:checked').value,
                    current_salary: parseFloat(document.getElementById('current_salary').value) || 0,
                },
                
                inss: {
                    cnis_start_year: parseInt(document.getElementById('cnis_start_year').value) || 1994,
                    simulate_disability: document.getElementById('simulate_disability').checked,
                    disability_type: document.querySelector('input[name="disability_type"]:checked').value,
                },
                
                financial: {
                    investment_years_target: parseInt(document.getElementById('investment_years_target').value) || 1,
                    inflation_rate: parseFloat(document.getElementById('inflation_rate').value) || 0,
                },
                
                cnis_salaries: history.cnisSalaries,
                investments: investmentList
            };

            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'simulacao_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage("Dados salvos com sucesso no arquivo 'simulacao_data.json'!");
        }

        function handleJsonUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    loadDataFromJson(data);
                    showMessage("Dados carregados com sucesso! Verifique e recalcule.");
                } catch (error) {
                    showMessage("Erro ao carregar o arquivo. Certifique-se de que é um arquivo JSON válido gerado pelo simulador.");
                    console.error("Erro ao processar JSON:", error);
                }
            };
            reader.readAsText(file);
        }

        function loadDataFromJson(data) {
            // 1. Dados Pessoais
            if (data.personal) {
                document.getElementById('birth_date').value = data.personal.birth_date || '1990-01-01';
                document.getElementById('current_salary').value = data.personal.current_salary || 0;
                
                const genderRadio = document.querySelector(`input[name="gender"][value="${data.personal.gender}"]`);
                if (genderRadio) genderRadio.checked = true;
                document.getElementById('birth_date').dispatchEvent(new Event('change'));
            }

            // 2. Dados INSS
            if (data.inss) {
                document.getElementById('cnis_start_year').value = data.inss.cnis_start_year || 1994;
                
                const disabilityCheckbox = document.getElementById('simulate_disability');
                disabilityCheckbox.checked = data.inss.simulate_disability === true;
                toggleDisabilityOptions();
                
                const disabilityRadio = document.querySelector(`input[name="disability_type"][value="${data.inss.disability_type}"]`);
                if (disabilityRadio) disabilityRadio.checked = true;
            }

            // 3. Tabela CNIS
            generateSalaryTable(data.cnis_salaries || {}); 

            // 4. Dados Financeiros
            if (data.financial) {
                document.getElementById('investment_years_target').value = data.financial.investment_years_target || 1;
                document.getElementById('inflation_rate').value = data.financial.inflation_rate || 0;
            }
            
            // 5. Investimentos Dinâmicos
            const container = document.getElementById('investments_container');
            container.innerHTML = ''; 
            investmentCounter = 0; 
            
            if (data.investments && data.investments.length > 0) {
                const maxId = data.investments.reduce((max, inv) => Math.max(max, inv.id), 0);
                investmentCounter = maxId;

                data.investments.forEach(invData => {
                    addInvestmentField(invData);
                });
            } else {
                addInvestmentField(); 
            }

            calculateAndDisplayProjections();
        }

        
        // --- FUNÇÃO PRINCIPAL DE CÁLCULO ---

        function calculateAndDisplayProjections() {
            // 1. Coleta de Dados
            const birthDate = document.getElementById('birth_date').value;
            const currentAge = calculateAge(birthDate);
            const inflationRate = parseFloat(document.getElementById('inflation_rate').value) / 100;
            
            // Leitura defensiva do Tempo de Investimento
            const investmentYearsTargetInput = document.getElementById('investment_years_target');
            let investmentYearsTarget = parseInt(investmentYearsTargetInput.value); 
            
            // Garantir que é um número válido, senão usa 1
            if (isNaN(investmentYearsTarget) || investmentYearsTarget <= 0) {
                 investmentYearsTarget = 1;
                 investmentYearsTargetInput.value = 1; // Força a atualização do campo se for inválido
            }

            const gender = document.querySelector('input[name="gender"]:checked').value;
            
            let investmentList = getInvestmentData();
            
            if (currentAge < 0) {
                showMessage("Por favor, insira uma Data de Nascimento válida.");
                return;
            }
            if (investmentList.length === 0) {
                addInvestmentField(); 
                investmentList = getInvestmentData(); 
            }

            toggleDisabilityOptions();

            document.getElementById('results_section').classList.remove('hidden');

            // --- CÁLCULO PREVIDENCIÁRIO (INSS) ---
            const history = analyzeContributionHistory(); 
            const averageMonthlySalary = calculateAverageSalary(history); 

            const inssResults = calculateINSSProjection(
                currentAge, gender, history, averageMonthlySalary
            );

            // Atualiza o display INSS
            document.getElementById('inss_average_salary_base').innerText = formatCurrency(averageMonthlySalary); 
            document.getElementById('inss_min_age').innerText = `${inssResults.minAge} anos`;
            document.getElementById('inss_min_time').innerText = `${inssResults.minContributionTime} anos`;
            document.getElementById('inss_remaining_time').innerText = inssResults.isDisability ? 'N/A' : `${inssResults.remainingTime.toFixed(1)} anos`;
            document.getElementById('inss_projected_income').innerText = formatCurrency(inssResults.projectedIncome);
            
            // --- CÁLCULO DE INVESTIMENTO COMPOSTO (Multi-Investimento) ---
            const yearsToRetirement = investmentYearsTarget; 
            
            let finalNominalCapital = 0;
            let finalRealCapital = 0;
            const chartDataRaw = []; 
            const investmentDetails = []; 

            investmentList.forEach((inv) => {
                const annualInterest = inv.interest;
                const monthlyContribution = inv.monthly;
                const initialInvestment = inv.initial;

                const monthlyInterest = Math.pow(1 + annualInterest, 1/12) - 1;
                const chartData = [];
                let futureValueNominal = initialInvestment;
                
                // Cálculo do Aporte Total Corrigido
                const totalMonthlyContribution = monthlyContribution * 12 * yearsToRetirement;
                const totalAportado = initialInvestment + totalMonthlyContribution;

                for (let i = 1; i <= yearsToRetirement; i++) {
                    for (let j = 0; j < 12; j++) {
                        futureValueNominal = (futureValueNominal * (1 + monthlyInterest)) + monthlyContribution;
                    }
                    
                    const realFutureValue = futureValueNominal / Math.pow(1 + inflationRate, i);

                    chartData.push([i, futureValueNominal, realFutureValue]);
                }
                
                if (chartData.length > 0) {
                    const nominalFinal = chartData[chartData.length - 1][1];
                    const realFinal = chartData[chartData.length - 1][2];

                    finalNominalCapital += nominalFinal;
                    finalRealCapital += realFinal;
                    
                    investmentDetails.push({
                        name: inv.name,
                        initial: initialInvestment,
                        contribution: totalMonthlyContribution, 
                        totalContribution: totalAportado, 
                        nominalFinal: nominalFinal,
                        realFinal: realFinal
                    });
                }

                chartDataRaw.push(chartData);
            });

            const aggregatedChartData = [['Ano', 'Capital Nominal Total (R$)', 'Capital Real Total (R$)']];
            
            for (let i = 1; i <= yearsToRetirement; i++) {
                let nominalTotal = 0;
                let realTotal = 0;

                chartDataRaw.forEach(chart => {
                    if (chart[i-1]) {
                        nominalTotal += chart[i-1][1];
                        realTotal += chart[i-1][2];
                    }
                });
                
                aggregatedChartData.push([
                    `Ano ${i}`, 
                    nominalTotal, 
                    realTotal
                ]);
            }

            const averageAnnualInterest = investmentList.length > 0 
                ? investmentList.reduce((sum, inv) => sum + inv.interest, 0) / investmentList.length 
                : 0;
            const passiveIncomeAnnualRate = averageAnnualInterest - inflationRate;
            
            const passiveIncomeMonthly = passiveIncomeAnnualRate > 0 
                ? (finalRealCapital * passiveIncomeAnnualRate) / 12
                : 0; 

            // 3. Exibe Resultados
            document.getElementById('years_to_retirement').innerText = `${yearsToRetirement} anos`;
            document.getElementById('total_nominal_capital').innerText = formatCurrency(finalNominalCapital);
            document.getElementById('total_real_capital').innerText = formatCurrency(finalRealCapital);
            document.getElementById('passive_income').innerText = formatCurrency(passiveIncomeMonthly);

            const summaryDiv = document.getElementById('detailed_investment_summary');
            let summaryHtml = '<p class="font-bold text-gray-800 mb-2">Detalhes por Investimento:</p>';
            
            investmentDetails.forEach(detail => {
                const totalReturnNominal = detail.nominalFinal - detail.totalContribution;
                const totalReturnReal = detail.realFinal - detail.totalContribution; 
                
                summaryHtml += `
                    <div class="pl-2 border-l-2 border-green-500">
                        <p class="font-semibold text-green-700">${detail.name} (Aporte Total: ${formatCurrency(detail.totalContribution)})</p>
                        <ul class="list-disc ml-4 text-sm text-gray-600">
                            <li>Capital Nominal Final: <span class="font-bold">${formatCurrency(detail.nominalFinal)}</span> (Ganho Nominal: ${formatCurrency(totalReturnNominal)})</li>
                            <li>Capital Real Final: <span class="font-bold text-green-600">${formatCurrency(detail.realFinal)}</span></li>
                        </ul>
                    </div>
                `;
            });
            summaryDiv.innerHTML = summaryHtml;


            // 4. Desenha Gráfico
            if (aggregatedChartData.length > 1) {
                 drawChart(aggregatedChartData);
            }
        }

        function drawChart(dataArray) {
            const data = google.visualization.arrayToDataTable(dataArray);

            const options = {
                title: 'Crescimento de Capital Total',
                curveType: 'function',
                legend: { position: 'bottom' },
                vAxis: { 
                    title: 'Valor Acumulado (R$)', 
                    format: 'short' 
                },
                hAxis: { title: 'Ano' },
                pointSize: 4,
                series: {
                    0: { color: '#4f46e5' }, 
                    1: { color: '#10b981' } 
                }
            };

            const chart = new google.visualization.LineChart(document.getElementById('investment_chart'));
            chart.draw(data, options);
        }

        // --- Inicialização ---

        window.onload = function() {
            if (document.getElementById('investments_container').children.length === 0) {
                addInvestmentField();
            }

            window.addEventListener('resize', function() {
                if (document.getElementById('results_section').classList.contains('hidden') === false) {
                    calculateAndDisplayProjections(); 
                }
            });
            
            document.getElementById('birth_date').addEventListener('change', () => {
                const age = calculateAge(document.getElementById('birth_date').value);
                document.getElementById('current_age_display').innerText = `Idade Atual: ${age} anos`;
            });
            
            generateSalaryTable();
            document.getElementById('birth_date').dispatchEvent(new Event('change'));
            calculateAndDisplayProjections();
        }
    </script>
</body>
</html>